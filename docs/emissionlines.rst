
.. |ang|   unicode:: U+212B

.. include:: include/links.rst

.. _emissionlines:

Emission-Line Measurements
==========================

Emission-Line Parameters
------------------------

The table below provides a compilation of emission-line parameters
gathered through the development of the DAP. Many of them have not
actually been fit by the DAP in any survey-level runs of the software
and are simply collected here for reference.

Rest wavelengths are `Ritz wavelengths
<https://physics.nist.gov/PhysRefData/ASD/Html/lineshelp.html#RITZ>`_ in
**vacuum**, collected from the `NIST Atomic Spectra Database
<https://physics.nist.gov/PhysRefData/ASD/lines_form.html>`_.

The "M1" and "E2" values are the Einstein :math:`A_{ki}` coefficients
for the magnetic dipole and electric quadrupole transitions,
respectively.  These are collected to fix the expected flux ratio
between specific line doublets.  The expected flux ratio is:

.. math::

    \frac{f_1}{f_2} = \frac{\lambda_2}{\lambda_1}\ \cdot\ \frac{M1_1+E2_1}{M1_2+E2_2}

where, e.g., :math:`\lambda_1` is the rest wavelength of the first line
in the doublet.

Additionally, we have defined some nominal passbands used for
calculations of the line equivalent width (EW), including the main
passband centered on the line and blue and red sidebands that are used
to construct a linear continuum beneath the emission line.

+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| Name                         |  Rest :math:`\lambda` (|ang|) |      M1 |      E2 | EW Passband (|ang|) |  Blue Passband (|ang|) | Red Passband (|ang|) |
+==============================+===============================+=========+=========+=====================+========================+======================+
| HeII [3]_                    |                     3204.019  |         |         |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| NeIII                        |                      3343.14  |         |         |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| NeV                          |                     3346.783  | 1.38e-1 |  6.2e-5 |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| NeV                          |                     3426.864  | 3.82e-1 |  3.9e-4 |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| NI [3]_                      |                     3467.513  |         |         |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H25                          |                     3670.5155 |         |         |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H24                          |                     3672.5279 |         |         |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H23                          |                     3674.8110 |         |         |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H22                          |                     3677.4160 |         |         |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H21                          |                     3680.4065 |         |         |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H20                          |                     3683.8627 |         |         |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H19                          |                     3687.8871 |         |         |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H18                          |                     3692.6119 |         |         |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H17                          |                     3698.2103 |         |         |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H16                          |                     3704.9132 |         |         |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H15                          |                     3713.0334 |         |         |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H14                          |                     3723.0035 |         |         |                [1]_ |       3706.3 -- 3716.3 |     3738.6 -- 3748.6 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| OII                          |                     3727.092  | 1.59e-4 | 1.86e-5 |    3716.3 -- 3738.3 |       3706.3 -- 3716.3 |     3738.6 -- 3748.6 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| OII                          |                     3729.875  | 1.98e-6 | 2.86e-5 |                [1]_ |       3706.3 -- 3716.3 |     3738.6 -- 3748.6 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H13                          |                     3735.4365 |         |         |                [1]_ |       3706.3 -- 3716.3 |     3738.6 -- 3748.6 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H12 [4]_                     |                     3751.2174 |         |         |    3746.2 -- 3756.2 |       3738.6 -- 3748.6 |     3756.6 -- 3766.6 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| H11 [4]_                     |                     3771.7012 |         |         |    3761.7 -- 3781.7 |       3756.6 -- 3766.6 |     3779.1 -- 3789.1 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| :math:`{\rm H}\theta` [4]_   |                     3798.9757 |         |         |    3789.0 -- 3809.0 |       3776.5 -- 3791.5 |     3806.5 -- 3821.5 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| :math:`{\rm H}\eta` [4]_     |                     3836.4720 |         |         |    3826.5 -- 3846.5 |       3806.5 -- 3826.5 |     3900.2 -- 3920.2 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| NeIII                        |                     3869.86   | 1.74e-1 |         |    3859.9 -- 3879.9 |       3806.5 -- 3826.5 |     3900.2 -- 3920.2 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| HeI [3]_                     |                     3889.749  |         |         |                [1]_ |       3806.5 -- 3826.5 |     3900.2 -- 3920.2 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| :math:`{\rm H}\zeta` [4]_    |                     3890.1506 |         |         |    3880.2 -- 3900.2 |       3806.5 -- 3826.5 |     3900.2 -- 3920.2 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| NeIII                        |                     3968.59   | 5.40e-2 |         |                [1]_ |       3938.6 -- 3958.6 |     3978.6 -- 3998.6 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| :math:`{\rm H}\epsilon` [4]_ |                     3971.1951 |         |         |    3961.2 -- 3981.2 |       3941.2 -- 3961.2 |     3981.2 -- 4001.2 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| HeI [3]_                     |                     4027.328  |         |         |    4017.3 -- 4037.3 |       3997.3 -- 4017.3 |     4037.3 -- 4057.3 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| SII                          |                     4069.749  | 1.92e-1 | 9.53e-8 |    4062.7 -- 4073.6 |       4049.7 -- 4062.7 |     4082.0 -- 4092.9 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| SII                          |                     4077.500  | 7.72e-2 | 1.16e-6 |    4073.6 -- 4084.5 |       4049.7 -- 4062.7 |     4082.0 -- 4092.9 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| :math:`{\rm H}\delta` [4]_   |                     4102.8922 |         |         |    4092.9 -- 4112.9 |       4082.0 -- 4092.9 |     4112.9 -- 4132.9 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| :math:`{\rm H}\gamma` [4]_   |                     4341.6837 |         |         |    4331.7 -- 4351.7 |       4311.7 -- 4331.7 |     4349.7 -- 4358.7 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| OIII                         |                     4364.436  | 1.71e+0 |         |    4358.7 -- 4374.4 |       4349.7 -- 4358.7 |     4374.4 -- 4384.4 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| HeI [3]_                     |                     4472.734  |         |         |    4462.7 -- 4482.7 |       4442.7 -- 4462.7 |     4482.7 -- 4502.7 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| HeII [3]_                    |                     4687.015  |         |         |    4677.0 -- 4697.0 |       4667.0 -- 4677.0 |     4697.0 -- 4707.0 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| ArIV [2]_                    |                     4712.58   | 9.6e-3  |         |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| HeI [3]_                     |                     4714.466  |         |         |    4707.0 -- 4722.0 |       4697.0 -- 4707.0 |     4722.0 -- 4732.0 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| ArIV                         |                     4741.45   |  7.2e-2 |  5.1e-3 |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| :math:`{\rm H}\beta` [4]_    |                     4862.6830 |         |         |    4852.7 -- 4872.7 |       4798.9 -- 4838.9 |     4885.6 -- 4925.6 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| HeI                          |                     4923.3051 |         |         |    4913.3 -- 4933.3 |       4898.3 -- 4913.3 |     4933.3 -- 4948.3 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| OIII                         |                     4960.295  | 6.21e-3 | 4.57e-6 |    4950.3 -- 4970.3 |       4930.3 -- 4950.3 |     4970.3 -- 4990.3 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| OIII                         |                     5008.240  | 1.81e-2 | 3.52e-5 |    4998.2 -- 5018.2 |       4978.2 -- 4998.2 |     5028.2 -- 5048.2 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| HeI                          |                     5017.0769 |         |         |                [1]_ |       4988.2 -- 4983.2 |     5028.2 -- 5048.2 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| ArIII                        |                       5193.27 |         | 3.10e+0 |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| NI                           |                     5199.349  | 1.60e-5 | 4.34e-6 |    5189.3 -- 5209.3 |       5169.4 -- 5189.3 |     5211.7 -- 5231.7 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| NI                           |                     5201.705  | 9.71e-7 | 6.59e-6 |                [1]_ |       5169.4 -- 5189.4 |     5211.7 -- 5231.7 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| OI                           |                      5578.887 |         | 1.26e+0 |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| NII                          |                     5756.19   |         | 1.14e+0 |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| HeI [3]_                     |                     5877.252  |         |         |    5867.2 -- 5887.2 |       5847.2 -- 5867.2 |     5887.2 -- 5907.2 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| NaI                          |                     5891.583  |         |         |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| NaI                          |                     5897.558  |         |         |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| OI                           |                     6302.046  | 5.63e-3 | 2.11e-5 |    6292.0 -- 6312.0 |       6272.0 -- 6292.0 |     6312.0 -- 6332.0 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| OI                           |                     6365.536  | 1.82e-3 | 3.39e-6 |    6355.5 -- 6375.5 |       6335.5 -- 6355.5 |     6375.5 -- 6395.5 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| NII                          |                     6549.86   | 9.84e-4 | 9.22e-7 |    6542.9 -- 6556.9 |       6483.0 -- 6513.0 |     6623.0 -- 6653.0 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| HeII [3]_                    |                     6561.890  |         |         |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| :math:`{\rm H}\alpha` [4]_   |                     6564.608  |         |         |    6557.6 -- 6571.6 |       6483.0 -- 6513.0 |     6623.0 -- 6653.0 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| NII                          |                     6585.27   | 2.91e-3 | 8.65e-6 |    6575.3 -- 6595.3 |       6483.0 -- 6513.0 |     6623.0 -- 6653.0 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| HeI                          |                     6679.9956 |         |         |    6670.0 -- 6690.0 |       6652.0 -- 6670.0 |     6690.0 -- 6708.0 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| SII                          |                     6718.295  | 1.39e-5 | 1.88e-4 |    6711.3 -- 6725.3 |       6690.0 -- 6708.0 |     6748.0 -- 6768.0 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| SII                          |                     6732.674  | 5.63e-4 | 1.21e-4 |    6725.7 -- 6739.7 |       6690.0 -- 6708.0 |     6748.0 -- 6768.0 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| HeI [3]_                     |                      7067.144 |         |         |    7057.1 -- 7077.1 |       7037.1 -- 7057.1 |     7077.1 -- 7097.1 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| HeI                          |                    7067.65683 |         |         |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| ArIII                        |                     7137.76   | 3.21e-1 |  1.4e-3 |    7127.8 -- 7147.8 |       7107.8 -- 7127.8 |     7147.8 -- 7167.8 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| ArIV                         |                     7172.67   |  8.1e-1 |  9.8e-2 |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| ArIV                         |                     7239.77   | 4.44e-1 | 2.26e-1 |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| ArIV                         |                     7265.33   | 4.88e-1 | 1.90e-1 |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| HeI                          |                     7283.3571 |         |         |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| OII                          |                     7320.94   |         | 5.19e-2 |                [1]_ |       7291.0 -- 7311.0 |     7342.8 -- 7362.8 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| OII                          |                     7322.01   | 8.37e-3 | 9.07e-2 |    7313.8 -- 7326.8 |       7291.0 -- 7311.0 |     7342.8 -- 7362.8 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| OII                          |                     7331.68   | 9.32e-3 | 7.74e-2 |    7326.8 -- 7339.8 |       7291.0 -- 7311.0 |     7342.8 -- 7362.8 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| OII                          |                     7332.75   | 1.49e-2 | 3.85e-2 |                [1]_ |       7291.0 -- 7311.0 |     7342.8 -- 7362.8 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| ArIV                         |                     7334.17   |         | 1.22e-1 |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| ArIII                        |                     7753.24   |  8.3e-2 |  1.3e-4 |    7743.2 -- 7763.2 |       7703.2 -- 7743.2 |     7763.2 -- 7803.2 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| ArIII                        |                     8038.73   |         |  2.9e-5 |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| P20                          |                     8394.703  |         |         |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| P19                          |                     8415.630  |         |         |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| P18                          |                     8440.274  |         |         |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| P17                          |                     8469.581  |         |         |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| P16                          |                     8504.819  |         |         |    8494.8 -- 8514.8 |       8474.8 -- 8494.8 |     8514.8 -- 8534.8 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| P15                          |                     8547.731  |         |         |    8534.8 -- 8557.7 |       8514.8 -- 8534.8 |     8557.7 -- 8587.7 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| P14                          |                     8600.754  |         |         |    8587.7 -- 8610.8 |       8557.7 -- 8587.7 |     8610.8 -- 8650.8 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| P13                          |                     8667.398  |         |         |    8657.4 -- 8677.4 |       8617.4 -- 8657.4 |     8677.4 -- 8717.4 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| P12                          |                     8752.876  |         |         |    8742.9 -- 8762.9 |       8702.9 -- 8742.9 |     8762.9 -- 8802.9 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| SIII                         |                     8831.8    |         | 5.25e-6 |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| :math:`{\rm P}\theta`        |                     8865.216  |         |         |    8855.2 -- 8875.2 |       8815.2 -- 8855.2 |     8875.2 -- 8915.2 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| :math:`{\rm P}\eta`          |                     9017.384  |         |         |    9007.4 -- 9027.4 |       8977.4 -- 9007.4 |     9027.4 -- 9057.4 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| SIII                         |                     9071.1    | 1.85e-2 | 3.94e-5 |    9061.1 -- 9081.1 |       9026.1 -- 9061.1 |     9081.1 -- 9116.1 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| HeI [3]_                     |                     9212.862  |         |         |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| :math:`{\rm P}\zeta`         |                     9231.546  |         |         |    9221.5 -- 9241.5 |       9181.5 -- 9221.5 |     9241.5 -- 9281.5 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| SIII                         |                     9533.2    | 4.78e-2 | 2.09e-4 |    9525.5 -- 9540.9 |       9483.2 -- 9523.2 |     9558.6 -- 9598.6 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| :math:`{\rm P}\epsilon`      |                     9548.588  |         |         |    9540.9 -- 9556.3 |       9483.2 -- 9523.2 |     9558.6 -- 9598.6 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| HeI [3]_                     |                     9528.778  |         |         |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| HeI [3]_                     |                    10030.470  |         |         |                     |                        |                      |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+
| :math:`{\rm P}\delta`        |                    10052.123  |         |         |  10042.1 -- 10062.1 |     10002.1 -- 10042.1 |   10062.1 -- 10102.1 |
+------------------------------+-------------------------------+---------+---------+---------------------+------------------------+----------------------+

.. _emissionlines-moments:

Non-parametric Emission-Line Measurements
-----------------------------------------

The DAP performs non-parametric measurements of the emission lines using
a simple moment analysis.  See :mod:`mangadap.proc.emissionlinemoments`
and :ref:`emission-line-moments`.  In survey-level runs of the DAP, we
have typically paired the set of moment measurements and Gaussian
models; however, the number of emission-line moment measurements need
not be matched to the number of emission-line Gaussian models and vice
versa.

Input Data Format
~~~~~~~~~~~~~~~~~

The parameters that define the emission-line moments to calculate are
provided via the
:class:`~mangadap.par.emissionmomentsdb.EmissionMomentsDB` object,
which is built using an `SDSS-style parameter file`_.

The columns of the parameter file are:

+---------------+-----------+-----------------------------------------------------------------------+
| Parameter     | Format    | Description                                                           |
+===============+===========+=======================================================================+
| ``index``     | int       | Unique integer identifier of the emission line.  **Must** be unique.  |
+---------------+-----------+-----------------------------------------------------------------------+
| ``name``      | str       | Name of the transition.                                               |
+---------------+-----------+-----------------------------------------------------------------------+
| ``lambda``    | float     | Rest frame wavelength of the emission line to analyze.                |
+---------------+-----------+-----------------------------------------------------------------------+
| ``waveref``   | str       | The reference frame of the wavelengths; must be either 'air' for air  |
|               |           | or 'vac' for vacuum.                                                  |
+---------------+-----------+-----------------------------------------------------------------------+
| ``primary``   | float[2]  | A two-element vector with the starting and ending wavelength for the  |
|               |           | primary passband surrounding the emission line(s).                    |
+---------------+-----------+-----------------------------------------------------------------------+
| ``blueside``  | float[2]  | A two-element vector with the starting and ending wavelength for a    |
|               |           | passband to the blue of the primary band.                             |
+---------------+-----------+-----------------------------------------------------------------------+
| ``redside``   | float[2]  | A two-element vector with the starting and ending wavelength for a    |
|               |           | passband to the red of the primary band.                              |
+---------------+-----------+-----------------------------------------------------------------------+

and an example file might look like this:

.. code-block:: c

    typedef struct {
        int index;
        char name[6];
        double lambda;
        char waveref[3];
        double primary[2];
        double blueside[2];
        double redside[2];
    } DAPELB;

    DAPELB   2  OIId    3728.4835  vac  { 3716.3  3738.3 } { 3706.3  3716.3 } { 3738.6  3748.6 }
    DAPELB   3  OII     3729.875   vac  {   -1      -1   } {   -1      -1   } {   -1      -1   }

Note in the above example that the second set of parameters define
nonsensical passbands with limits of ``{-1 -1}``. This is used to
signify that the moment parameters are "dummy" or placeholder
parameters. This is used to create an empty channel in the output
``MAPS`` file and is used just to synchronize the channel indices
between the non-parametric and Gaussian-fit results. That is, it's
used to ensure that, e.g., the :math:`{\rm H}\alpha` measurements are
in the same channel for both the ``EMLINE_SFLUX`` and
``EMLINE_GFLUX`` extensions in the :ref:`datamodel-maps`.

Changing the moment parameters
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The moment measurements are performed by
:class:`~mangadap.proc.emissionlinemoments.EmissionLineMoments`; see
:ref:`emission-line-moments`. A set of parameter files that define a list of
emission-line moment sets are provided with the DAP source distribution and
located at ``$MANGADAP_DIR/mangadap/data/emission_bandpass_filters``.  The
database you wish to use is selected by the ``passbands`` parameter in the
relevant parameter block of the :ref:`plan` file.  The keyword is simply the
capitalized name of the file without the ".par" extension.  For example, to use
the `elbmpl9.par
<https://github.com/sdss/mangadap/blob/main/mangadap/data/emission_bandpass_filters/elbmpl9.par>`__
database, the plan file would include

.. code-block:: toml

    [default.eline_moments]
     passbands = 'ELBMPL9'

To provide a user-defined database, simply replace the ``passbands`` keyword
with the name of the local file defining the database (in the format given
above).  For example, 

.. code-block:: toml

    [default.eline_moments]
     passbands = '/path/to/my/local/file/my_elb_database.par'

.. _emissionlines-modeling:

Gaussian Emission-Line Modeling
-------------------------------

The DAP models the emission lines using single-component Gaussian functions.
See :mod:`mangadap.proc.emissionlinemoments` and :ref:`emission-line-modeling`.
In survey-level runs of the DAP, we have typically paired the set of moment
measurements and Gaussian models; however, the number of emission-line moment
measurements need not be matched to the number of emission-line Gaussian models
and vice versa.

.. _emissionlines-model-par-format:

Input Data Format
~~~~~~~~~~~~~~~~~

The parameters that define the emission-line models to fit are provided via the
:class:`~mangadap.par.emissionlinedb.EmissionLineDB` object, which is built
using an `SDSS-style parameter file`_.

The columns of the parameter file are:

+-------------------+-----------+-----------------------------------------------------------------------+
| Parameter         | Format    | Description                                                           |
+===================+===========+=======================================================================+
| ``index``         | int       | Unique integer identifier of the emission line.  **Must** be unique.  |
|                   |           | Specifically used when tying line parameters.                         |
+-------------------+-----------+-----------------------------------------------------------------------+
| ``name``          | str       | Name of the transition.                                               |
+-------------------+-----------+-----------------------------------------------------------------------+
| ``restwave``      | float     | Rest frame wavelength of the emission line to analyze.                |
+-------------------+-----------+-----------------------------------------------------------------------+
| ``waveref``       | str       | The reference frame of the wavelengths; must be either 'air' for air  |
|                   |           | or 'vac' for vacuum.                                                  |
+-------------------+-----------+-----------------------------------------------------------------------+
| ``action``        | str       | A single character setting how the line should be treated.  See       |
|                   |           | :ref:`emission-line-modeling-action`.                                 |
+-------------------+-----------+-----------------------------------------------------------------------+
| ``tie_f``         | str[2]    | A sequence of 2 10-character strings that indicate how the flux of    |
|                   |           | the line should be tied to another line.  The first element gives the |
|                   |           | index of the line to tie (see ``index`` above).  The second element   |
|                   |           | provides the constraint.  Currently fluxes can only be tied by        |
|                   |           | fixing the line flux ratio, and lines with tied fluxes must also have |
|                   |           | their velocity and velocity dispersions tied by equality.  For        |
|                   |           | example, to fix the ratio of the OIII 4959 line to the OIII 5007      |
|                   |           | line, the entry for the OIII 4959 line should be ``{  14 =0.34 }``,   |
|                   |           | where 14 is the index number of the OIII 5007 in the file and the     |
|                   |           | flux in the OIII 4959 line is always 0.34 times the flux in the       |
|                   |           | OIII 5007 line.                                                       |
+-------------------+-----------+-----------------------------------------------------------------------+
| ``tie_v``         | str[2]    | A sequence of 2 10-character strings that indicate how the velocity   |
|                   |           | of the line should be tied to another line.  The first element gives  |
|                   |           | the index of the line to tie (see ``index`` above).  The second       |
|                   |           | element provides the constraint.  Velocities can be tied by equality  |
|                   |           | (using ``=``) or tied by inequality (see below); however, tying by    |
|                   |           | inequality is not well tested.                                        |
+-------------------+-----------+-----------------------------------------------------------------------+
| ``tie_s``         | str[2]    | A sequence of 2 10-character strings that indicate how the velocity   |
|                   |           | dispersion of the line should be tied to another line.  The first     |
|                   |           | element gives the index of the line to tie (see ``index`` above).     |
|                   |           | The second element provides the constraint.  Velocity dispersions can |
|                   |           | can be tied by equality (using ``=``) or tied by inequality (see      |
|                   |           | below).                                                               |
+-------------------+-----------+-----------------------------------------------------------------------+
| ``blueside``      | float[2]  | A two-element vector with the starting and ending wavelength for a    |
|                   |           | passband to the blue of the primary band.                             |
+-------------------+-----------+-----------------------------------------------------------------------+
| ``redside``       | float[2]  | A two-element vector with the starting and ending wavelength for a    |
|                   |           | passband to the red of the primary band.                              |
+-------------------+-----------+-----------------------------------------------------------------------+

and an example file might look like this:

.. code-block:: c

    typedef struct {
        int index;
        char name[6];
        double restwave;
        char waveref[3];
        char action;
        char tie_f[2][10];
        char tie_v[2][10];
        char tie_s[2][10];
        double blueside[2];
        double redside[2];
    } DAPEML;

    DAPEML   2  OII     3727.092   vac  f  { None   None }  {   34      = }  { None   None }  {  3706.3  3716.3 }  {  3738.6  3748.6 }
    DAPEML   3  OII     3729.875   vac  f  { None   None }  {    2      = }  {    2      = }  {  3706.3  3716.3 }  {  3738.6  3748.6 }
    DAPEML  23  Hb      4862.6830  vac  f  { None   None }  {   34      = }  {   34    1.4 }  {  4798.9  4838.9 }  {  4885.6  4925.6 }
    DAPEML  33  NII     6549.86    vac  f  {   35  =0.34 }  {   35      = }  {   35      = }  {  6483.0  6513.0 }  {  6623.0  6653.0 }
    DAPEML  34  Ha      6564.608   vac  f  { None   None }  { None   None }  { None   None }  {  6483.0  6513.0 }  {  6623.0  6653.0 }
    DAPEML  35  NII     6585.27    vac  f  { None   None }  {   34      = }  { None   None }  {  6483.0  6513.0 }  {  6623.0  6653.0 }

.. note::

    * Both the emission-line moments database and the emission-line
      modeling database define the sidebands used for the equivalent
      width calculations.  Nominally, these should be the same, but it's
      up to the person that writes the two parameter files to make sure
      that is true.
      
    * Format changes:
        - version 3.1.0: Many parameters removed that were used by the
          deprecated :class:`~mangadap.proc.elric.Elric` fitter.
        - version 4.1.0: Added ability to tie the three parameters to different
          lines; i.e., velocity can be tied to one line while dispersion is tied
          to a different one.

.. _emission-line-modeling-action:

Emission-Line "Actions"
+++++++++++++++++++++++

.. include:: include/emissionline-action.rst

.. _emission-line-modeling-mode:

Emission-Line Tying
+++++++++++++++++++

Line tying in the DAP uses the functionality in `ppxf`_ in a limited and
abstracted way.

**Tying fluxes** effectively means that the lines are put in the same
emission-line template.  This is why, currently, any lines with tied fluxes must
also tie their velocity and velocity dispersion.  Also, the DAP currently does
not allow tying fluxes using inequalities.

**Tying kinematics** can be done with equality or inequality.  For equality, use
the ``=`` character, as in the example file above.  Unlike the fluxes, the
kinematics cannot be tied to be, e.g., a specific fraction of the value of the
tied line.  (I.e., you can't tie the dispersion to be exactly half of the
dispersion of the tied line).  For inequality, there are a couple of options:

    #. Use ``>N`` or ``<N`` to force the value to be greater or less than the
       provided fraction of the the value of the tied line.  E.g., to force the
       dispersion of one component to be at least 1.5 times larger than the tied
       line, use ``>1.5``.  Using ``>`` or ``<`` is equivalent to ``>1`` and
       ``<``, respectively.

    #. To bound the value between both upper and lower limits, you must use a
       *single* fixed fractional bound.  For example, setting the tied value for
       the dispersion to ``1.4`` means that the best-fitting dispersion must be
       greater than 1/1.4 and less than 1.4 times the dispersion of the tied
       line.

.. warning::

    Although line tying has been experimented with for MaNGA data, much of the
    inequality tying is not well tested.

Emission-Line "Modes"
+++++++++++++++++++++

.. warning::

    This parameter is now DEPRECATED in favor of the ``tie`` parameter.

.. include:: include/emissionline-mode.rst

Changing the modeling parameters
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The moment measurements are performed by
:class:`~mangadap.proc.emissionlinemoments.EmissionLineMoments`; see
:ref:`emission-line-moments`. A set of parameter files that define a list of
emission-line moment sets are provided with the DAP source distribution and
located at ``$MANGADAP_DIR/mangadap/data/emission_bandpass_filters``.  The
database you wish to use is selected by the ``passbands`` parameters in the
relevant parameter block of the :ref:`plan` file.  The keyword is simply the
capitalized name of the file without the ".par" extension.  To provide a
user-defined database, simply replace the ``passbands`` keyword with the name of
the local file defining the database (in the format given above).

The emission-line modeling is performed by
:class:`~mangadap.proc.emissionlinemodel.EmissionLineModel`; see
:ref:`emission-line-modeling`. A set of files that define a list of
emission-line model parameter sets are provided with the DAP source distribution
and located at ``$MANGADAP_DIR/mangadap/data/emission_lines``.  The database you
wish to use is selected by the ``emission_lines`` parameter in the relevant
parameter block of the :ref:`plan` file.  The keyword is simply the capitalized
name of the file without the ".par" extension.  For example, to use the
`elpmpl11.par
<https://github.com/sdss/mangadap/blob/main/mangadap/data/emission_lines/elpmpl11.par>`__
database, the plan file would include

.. code-block:: toml

    [default.eline_fits.fit]
     emissionpassbands = 'ELPMPL11'

To provide a user-defined database, simply replace the ``passbands`` keyword
with the name of the local file defining the database (in the format given
above).  For example, 

.. code-block:: toml

    [default.eline_fits.fit]
     emissionpassbands = '/path/to/my/local/file/my_elp_database.par'

----

.. [1] No primary band defined because it overlaps with another line.
.. [2] Provided magnetic dipole coefficient is actually its sum with the electric quadrupole coefficient.
.. [3] Wavelength based on a simple average of wavelengths for many fine-structure transitions.
.. [4] Center of gravity of the blending of fine-structure lines assuming Boltzmann populations in an optically thin plasma; see, e.g.: https://physics.nist.gov/cgi-bin/ASBib1/get_ASBib_ref.cgi?db=el&db_id=&comment_code=c69&element=H&spectr_charge=1&ref=&type=

